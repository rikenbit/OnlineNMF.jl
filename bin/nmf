using OnlineNMF
using ArgParse:
    ArgParseSettings, parse_args, @add_arg_table

# main
function main()
    nmfmodel = OnlineNMF.NMF()
    parsed_args = OnlineNMF.parse_commandline(nmfmodel)
    println("Parsed args:")
    for (arg, val) in parsed_args
        println("  $arg  =>  ", repr(val))
    end

    alpha = parse(Int64, parsed_args["alpha"])
    beta = parse(Int64, parsed_args["beta"])
    graphv = parse(Float32, parsed_args["graphv"])
    l1u = parse(Float32, parsed_args["l1u"])
    l1v = parse(Float32, parsed_args["l1v"])
    l2u = parse(Float32, parsed_args["l2u"])
    l2v = parse(Float32, parsed_args["l2v"])
    dim = parse(Int64, parsed_args["dim"])

    if parsed_args["numepoch"] == 5
        numepoch = 5
    else
        numepoch = parse(Int64, parsed_args["numepoch"])
    end

    if parsed_args["chunksize"] == 1
        chunksize = 1
    else
        chunksize = parse(Int64, parsed_args["chunksize"])
    end

    if parsed_args["lower"] == 0
        lower = 0
    else
        lower = parse(Float32, parsed_args["lower"])
    end

    if parsed_args["upper"] == 1.0f+38
        upper = 1.0f+38
    else
        upper = parse(Float32, parsed_args["upper"])
    end

    if parsed_args["initU"] == nothing
        initU = parsed_args["initU"]
    else
        initU = String(parsed_args["initU"])
    end

    if parsed_args["initV"] == nothing
        initV = parsed_args["initV"]
    else
        initV = String(parsed_args["initV"])
    end

    if parsed_args["initL"] == nothing
        initL = parsed_args["initL"]
    else
        initL = String(parsed_args["initL"])
    end

    if parsed_args["logdir"] == nothing
        logdir = parsed_args["logdir"]
    else
        logdir = String(parsed_args["logdir"])
    end

    out = OnlineNMF.nmf(input=parsed_args["input"],
        alpha=alpha,
        beta=beta,
        graphv=graphv,
        l1u=l1u,
        l1v=l1v,
        l2u=l2u,
        l2v=l2v,
        dim=dim,
        numepoch=numepoch,
        chunksize=chunksize,
        lower=lower,
        upper=upper,
        initU=initU,
        initV=initV,
        initL=initL,
        logdir=logdir)
    OnlineNMF.output(parsed_args["outdir"], out, lower)
end

main()